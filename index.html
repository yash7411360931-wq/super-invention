<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#667eea" />
  <meta name="description" content="AI-Powered Plant Disease Detector - Works Offline!" />
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUGxhbnQgRGlzZWFzZSBEZXRlY3RvciBQcm8iLCJzaG9ydF9uYW1lIjoiUGxhbnREb2N0b3IiLCJkZXNjcmlwdGlvbiI6IkFJLVBvd2VyZWQgUGxhbnQgSGVhbHRoIEFuYWx5c2lzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiM2NjdlZWEiLCJ0aGVtZV9jb2xvciI6IiM2NjdlZWEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3RleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCclM0UlRjAlOUYlOEMlQjElM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=" />
  <title>üå± Plant Disease Detector Pro - PWA</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ff6b6b;
      color: white;
      text-align: center;
      padding: 10px;
      z-index: 3000;
      display: none;
    }
    .offline-banner.show { display: block; }
    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: none;
      z-index: 2000;
      max-width: 400px;
    }
    .install-prompt.show { display: block; }
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      margin-top: 20px;
    }
    .header h1 { font-size: 42px; font-weight: 700; margin-bottom: 10px; }
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    .status-online { background: #43e97b; color: white; }
    .status-offline { background: #ffc107; color: #333; }
    .top-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    .lang-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .lang-btn.active { background: rgba(255, 255, 255, 0.9); color: #667eea; }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px 20px;
      margin: 20px 0;
      cursor: pointer;
      text-align: center;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    #imagePreview { max-width: 100%; max-height: 300px; border-radius: 15px; margin-top: 15px; display: none; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    button:hover { transform: scale(1.05); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .health-score {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 20px;
      display: none;
    }
    .score-circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: white;
      margin: 10px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 700;
      color: #43e97b;
    }
    .history-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 15px;
    }
    .history-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-item:hover { background: #e0c3fc; transform: translateX(5px); }
    .history-item img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; }
    .pending-badge {
      background: #ffc107;
      color: #333;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }
    .synced-badge {
      background: #43e97b;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }
    #loading { display: none; text-align: center; padding: 20px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .offline-db-section {
      background: #fff3cd;
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }
    .disease-card {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    .features-section {
      max-width: 1400px;
      margin: 50px auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .feature-card {
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      transition: all 0.3s;
    }
    .feature-card:hover { transform: translateY(-10px); }
    .feature-icon { font-size: 40px; margin-bottom: 10px; }
    @media (max-width: 768px) { 
      .container { grid-template-columns: 1fr; } 
      .top-controls { position: static; justify-content: center; margin-bottom: 20px; }
    }
  </style>
</head>
<body>
  <div class="offline-banner" id="offlineBanner">
    üì° You're offline. AI analysis will be queued and synced when online.
  </div>

  <div class="install-prompt" id="installPrompt">
    <h3>üì± Install Plant Doctor</h3>
    <p>Install this app on your device for offline access!</p>
    <div style="margin-top: 15px; display: flex; gap: 10px;">
      <button onclick="installApp()">Install</button>
      <button style="background: #ccc;" onclick="dismissInstall()">Later</button>
    </div>
  </div>

  <div class="top-controls">
    <button class="lang-btn" onclick="triggerInstall()" style="background: #43e97b; color: white; border-color: #43e97b;">
      üì• Install App
    </button>
    <button class="lang-btn active" data-lang="en">English</button>
    <button class="lang-btn" data-lang="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
  </div>

  <div class="header">
    <h1>üå± Plant Disease Detector Pro</h1>
    <p>AI-Powered PWA - Works Offline!</p>
    <div class="status-badge" id="statusBadge">
      <span id="statusText">üü¢ Online</span>
    </div>
    
    <!-- Install Instructions Box -->
    <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 15px; border-radius: 15px; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
      <p style="color: white; font-size: 14px; margin-bottom: 10px;">üí° <strong>Install this app for offline access!</strong></p>
      <button onclick="triggerInstall()" style="background: #43e97b; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: 600;">
        üì• Click Here to Install
      </button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="health-score" id="healthScore">
        <h3>Plant Health Score</h3>
        <div class="score-circle" id="scoreValue">--</div>
        <p id="scoreStatus">Upload image to analyze</p>
      </div>

      <h2 id="uploadTitle">Upload Plant Image</h2>
      
      <div class="upload-area" onclick="document.getElementById('imageInput').click()">
        <div style="font-size: 48px;">üì∏</div>
        <p id="uploadDesc">Click to upload or take photo</p>
        <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none;" />
      </div>

      <img id="imagePreview" />

      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
        <button id="detectBtn">üîç <span id="detectBtnText">Detect Disease</span></button>
        <button style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="clearAll()">üóëÔ∏è <span id="clearBtnText">Clear</span></button>
      </div>

      <div class="history-section">
        <h3 id="historyTitle">üìú Recent Scans</h3>
        <div id="historyList">
          <p style="text-align: center; color: #999; padding: 20px;">No scans yet</p>
        </div>
      </div>

      <div class="offline-db-section">
        <h3>üìö Offline Disease Database</h3>
        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Quick reference when offline</p>
        <div id="offlineDb"></div>
      </div>
    </div>

    <div class="card">
      <div id="loading">
        <div class="spinner"></div>
        <p id="loadingText">Analyzing with AI...</p>
      </div>

      <div id="result" style="display: none;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin: -30px -30px 20px -30px;">
          <h2>üìã <span id="resultTitle">Analysis Results</span></h2>
        </div>
        <div id="resultContent"></div>

        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="downloadReport()">üíæ <span id="downloadText">Download</span></button>
          <button onclick="shareResult()">üì§ <span id="shareText">Share</span></button>
        </div>
      </div>

      <div id="placeholder" style="text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 64px;">üå±</div>
        <p id="placeholderText">Upload an image to start analysis</p>
        <p style="font-size: 14px; margin-top: 10px;">Works offline with cached data!</p>
      </div>
    </div>
  </div>

  <div class="features-section">
    <h2 style="text-align: center; color: #667eea; font-size: 32px; margin-bottom: 30px;">‚ú® PWA Features</h2>
    <div class="feature-grid">
      <div class="feature-card">
        <div class="feature-icon">üì±</div>
        <h3>Installable App</h3>
        <p>Install on your device like a native app</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üì°</div>
        <h3>Works Offline</h3>
        <p>Access cached results without internet</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üîÑ</div>
        <h3>Auto Sync</h3>
        <p>Queued scans sync when online</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üíæ</div>
        <h3>Local Storage</h3>
        <p>All your data saved locally</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üî¨</div>
        <h3>AI Detection</h3>
        <p>Advanced disease identification</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üìö</div>
        <h3>Offline Database</h3>
        <p>Common diseases info available offline</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üåê</div>
        <h3>Bilingual</h3>
        <p>English & Hindi support</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üì∏</div>
        <h3>Camera Support</h3>
        <p>Take photos directly</p>
      </div>
    </div>
  </div>

  <script>
    const translations = {
      en: {
        uploadTitle: "Upload Plant Image",
        uploadDesc: "Click to upload or take photo",
        detectBtnText: "Detect Disease",
        clearBtnText: "Clear",
        historyTitle: "Recent Scans",
        resultTitle: "Analysis Results",
        placeholderText: "Upload an image to start analysis",
        loadingText: "Analyzing with AI...",
        downloadText: "Download",
        shareText: "Share"
      },
      hi: {
        uploadTitle: "‡§™‡•å‡§ß‡•á ‡§ï‡•Ä ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
        uploadDesc: "‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Ø‡§æ ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç",
        detectBtnText: "‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§™‡§π‡§ö‡§æ‡§®‡•á‡§Ç",
        clearBtnText: "‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç",
        historyTitle: "‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§∏‡•ç‡§ï‡•à‡§®",
        resultTitle: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ",
        placeholderText: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
        loadingText: "AI ‡§ï‡•á ‡§∏‡§æ‡§• ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...",
        downloadText: "‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°",
        shareText: "‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç"
      }
    };

    let currentLang = 'en';
    let isOnline = navigator.onLine;
    let deferredPrompt;
    let pendingScans = [];
    let scanHistory = [];

    // Offline disease database
    const offlineDiseases = [
      { name: "Leaf Blight", symptoms: "Brown spots on leaves", treatment: "Remove affected leaves, apply copper fungicide" },
      { name: "Powdery Mildew", symptoms: "White powdery coating", treatment: "Neem oil spray, improve air circulation" },
      { name: "Root Rot", symptoms: "Wilting, yellowing", treatment: "Reduce watering, improve drainage" },
      { name: "Leaf Spot", symptoms: "Dark spots with yellow halo", treatment: "Remove infected leaves, fungicide spray" }
    ];

    // Initialize
    window.addEventListener('load', () => {
      registerServiceWorker();
      checkOnlineStatus();
      loadHistory();
      loadOfflineDatabase();
      setupLanguage();
    });

    // Service Worker Registration
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        const swCode = `
          self.addEventListener('install', (e) => {
            e.waitUntil(
              caches.open('plant-detector-v1').then((cache) => {
                return cache.addAll(['/']);
              })
            );
          });
          self.addEventListener('fetch', (e) => {
            e.respondWith(
              caches.match(e.request).then((response) => {
                return response || fetch(e.request);
              })
            );
          });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl);
      }
    }

    // Install PWA prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installPrompt').classList.add('show');
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null;
          document.getElementById('installPrompt').classList.remove('show');
        });
      } else {
        showInstallInstructions();
      }
    }

    function triggerInstall() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            alert('‚úÖ App installed successfully!');
          }
          deferredPrompt = null;
        });
      } else {
        showInstallInstructions();
      }
    }

    function showInstallInstructions() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      
      let message = '';
      
      if (isIOS) {
        message = 'üì± To install on iPhone/iPad:\n\n1. Tap the Share button (‚ñ°‚Üë)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add"';
      } else if (isAndroid) {
        message = 'üì± To install on Android:\n\n1. Tap the menu (‚ãÆ) in browser\n2. Tap "Add to Home Screen" or "Install App"\n3. Tap "Install"';
      } else {
        message = 'üíª To install on Desktop:\n\n1. Look for the install icon (‚äï) in the address bar\n2. Or click browser menu (‚ãÆ)\n3. Select "Install Plant Disease Detector"';
      }
      
      alert(message);
    }

    function dismissInstall() {
      document.getElementById('installPrompt').classList.remove('show');
    }

    // Online/Offline detection
    function checkOnlineStatus() {
      updateOnlineStatus();
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
    }

    function updateOnlineStatus() {
      isOnline = navigator.onLine;
      const statusText = document.getElementById('statusText');
      const offlineBanner = document.getElementById('offlineBanner');
      
      if (isOnline) {
        statusText.textContent = 'üü¢ Online';
        statusText.parentElement.className = 'status-badge status-online';
        offlineBanner.classList.remove('show');
        syncPendingScans();
      } else {
        statusText.textContent = 'üî¥ Offline';
        statusText.parentElement.className = 'status-badge status-offline';
        offlineBanner.classList.add('show');
      }
    }

    // Language switching
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentLang = btn.dataset.lang;
        updateLanguage();
      });
    });

    function setupLanguage() {
      updateLanguage();
    }

    function updateLanguage() {
      const t = translations[currentLang];
      Object.keys(t).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.textContent = t[key];
      });
    }

    // Load offline database
    function loadOfflineDatabase() {
      const container = document.getElementById('offlineDb');
      container.innerHTML = offlineDiseases.map(d => `
        <div class="disease-card">
          <h4>${d.name}</h4>
          <p><strong>Symptoms:</strong> ${d.symptoms}</p>
          <p><strong>Treatment:</strong> ${d.treatment}</p>
        </div>
      `).join('');
    }

    // File handling
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    let selectedFile = null;
    let base64Image = null;

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (evt) => {
          imagePreview.src = evt.target.result;
          imagePreview.style.display = 'block';
          base64Image = evt.target.result.split(',')[1];
        };
        reader.readAsDataURL(file);
      }
    });

    // Detection
    document.getElementById('detectBtn').addEventListener('click', async () => {
      if (!selectedFile || !base64Image) {
        alert(currentLang === 'hi' ? '‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§' : 'Please select an image first.');
        return;
      }

      document.getElementById('placeholder').style.display = 'none';
      document.getElementById('result').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('detectBtn').disabled = true;

      if (!isOnline) {
        // Queue for later
        const scan = {
          id: Date.now(),
          image: base64Image,
          timestamp: new Date().toISOString(),
          status: 'pending'
        };
        pendingScans.push(scan);
        localStorage.setItem('pendingScans', JSON.stringify(pendingScans));
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('resultContent').innerHTML = `
          <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
            <h3>üì° Queued for Analysis</h3>
            <p>You're offline. This scan will be analyzed automatically when you reconnect to the internet.</p>
            <p style="margin-top: 10px;">Meanwhile, check the offline disease database below for quick reference.</p>
          </div>
        `;
        document.getElementById('detectBtn').disabled = false;
        addToHistory(scan);
        return;
      }

      try {
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer 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',
            'HTTP-Referer': window.location.href,
            'X-Title': 'Plant Disease Detector PWA'
          },
          body: JSON.stringify({
            model: 'anthropic/claude-3.5-sonnet',
            messages: [{
              role: 'user',
              content: [
                {
                  type: 'image_url',
                  image_url: { url: `data:${selectedFile.type};base64,${base64Image}` }
                },
                {
                  type: 'text',
                  text: currentLang === 'hi' 
                    ? '‡§á‡§∏ ‡§™‡•å‡§ß‡•á ‡§ï‡•Ä ‡§™‡§§‡•ç‡§§‡•Ä ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä, ‡§≤‡§ï‡•ç‡§∑‡§£, ‡§â‡§™‡§ö‡§æ‡§∞ ‡§î‡§∞ ‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç‡•§'
                    : 'Analyze this plant leaf and provide disease name, symptoms, treatment, and prevention.'
                }
              ]
            }]
          })
        });

        const data = await response.json();
        const result = data.choices[0].message.content;

        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('resultContent').innerHTML = `<div style="white-space: pre-wrap;">${result}</div>`;
        document.getElementById('detectBtn').disabled = false;

        // Calculate health score
        const score = result.toLowerCase().includes('healthy') ? 95 : 
                     result.toLowerCase().includes('severe') ? 35 : 65;
        showHealthScore(score);

        // Save to history
        const scan = {
          id: Date.now(),
          image: imagePreview.src,
          result: result.substring(0, 100) + '...',
          timestamp: new Date().toISOString(),
          status: 'synced',
          score: score
        };
        addToHistory(scan);

      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('resultContent').innerHTML = `
          <div style="background: #ff6b6b; color: white; padding: 20px; border-radius: 10px;">
            <h3>‚ùå Error</h3>
            <p>${error.message}</p>
          </div>
        `;
        document.getElementById('detectBtn').disabled = false;
      }
    });

    function showHealthScore(score) {
      document.getElementById('healthScore').style.display = 'block';
      document.getElementById('scoreValue').textContent = score;
      document.getElementById('scoreStatus').textContent = 
        score > 80 ? 'Healthy Plant! üåü' :
        score > 50 ? 'Needs Attention ‚ö†Ô∏è' :
        'Critical Condition üö®';
    }

    // History management
    function loadHistory() {
      const saved = localStorage.getItem('scanHistory');
      if (saved) {
        scanHistory = JSON.parse(saved);
        renderHistory();
      }
      const pending = localStorage.getItem('pendingScans');
      if (pending) {
        pendingScans = JSON.parse(pending);
      }
    }

    function addToHistory(scan) {
      scanHistory.unshift(scan);
      if (scanHistory.length > 20) scanHistory.pop();
      localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
      renderHistory();
    }

    function renderHistory() {
      const container = document.getElementById('historyList');
      if (scanHistory.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No scans yet</p>';
        return;
      }
      container.innerHTML = scanHistory.map(scan => `
        <div class="history-item" onclick="viewScan('${scan.id}')">
          <div style="display: flex; gap: 15px; align-items: center;">
            ${scan.image ? `<img src="${scan.image}" />` : '<div style="width:60px;height:60px;background:#e0e0e0;border-radius:10px;"></div>'}
            <div>
              <div style="font-weight: 600;">${new Date(scan.timestamp).toLocaleDateString()}</div>
              <div style="font-size: 12px; color: #666;">${scan.result || 'Pending analysis'}</div>
            </div>
          </div>
          <span class="${scan.status === 'pending' ? 'pending-badge' : 'synced-badge'}">
            ${scan.status === 'pending' ? '‚è≥ Pending' : '‚úì Synced'}
          </span>
        </div>
      `).join('');
    }

    function viewScan(id) {
      const scan = scanHistory.find(s => s.id == id);
      if (scan && scan.result) {
        document.getElementById('result').style.display = 'block';
        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('resultContent').innerHTML = `<div style="white-space: pre-wrap;">${scan.result}</div>`;
        if (scan.score) showHealthScore(scan.score);
      }
    }

    // Sync pending scans
    async function syncPendingScans() {
      if (pendingScans.length === 0) return;
      
      console.log(`Syncing ${pendingScans.length} pending scans...`);
      
      for (const scan of pendingScans) {
        try {
          const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer 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',
              'HTTP-Referer': window.location.href,
              'X-Title': 'Plant Disease Detector PWA'
            },
            body: JSON.stringify({
              model: 'anthropic/claude-3.5-sonnet',
              messages: [{
                role: 'user',
                content: [
                  {
                    type: 'image_url',
                    image_url: { url: `data:image/jpeg;base64,${scan.image}` }
                  },
                  {
                    type: 'text',
                    text: 'Analyze this plant leaf and provide disease name, symptoms, treatment, and prevention.'
                  }
                ]
              }]
            })
          });

          const data = await response.json();
          const result = data.choices[0].message.content;
          
          // Update scan in history
          const historyIndex = scanHistory.findIndex(s => s.id === scan.id);
          if (historyIndex !== -1) {
            scanHistory[historyIndex].result = result.substring(0, 100) + '...';
            scanHistory[historyIndex].status = 'synced';
            scanHistory[historyIndex].score = result.toLowerCase().includes('healthy') ? 95 : 65;
          }
          
          // Remove from pending
          pendingScans = pendingScans.filter(s => s.id !== scan.id);
          
        } catch (error) {
          console.error('Failed to sync scan:', error);
        }
      }
      
      localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
      localStorage.setItem('pendingScans', JSON.stringify(pendingScans));
      renderHistory();
      
      if (pendingScans.length === 0) {
        alert('‚úÖ All pending scans synced successfully!');
      }
    }

    // Clear function
    function clearAll() {
      selectedFile = null;
      base64Image = null;
      imagePreview.style.display = 'none';
      imageInput.value = '';
      document.getElementById('result').style.display = 'none';
      document.getElementById('placeholder').style.display = 'block';
      document.getElementById('healthScore').style.display = 'none';
    }

    // Download report
    function downloadReport() {
      const resultContent = document.getElementById('resultContent');
      if (!resultContent || !resultContent.textContent) {
        alert(currentLang === 'hi' ? '‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§' : 'No result to download.');
        return;
      }
      
      const content = resultContent.textContent;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `plant-analysis-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(currentLang === 'hi' ? '‚úÖ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!' : '‚úÖ Report downloaded!');
    }

    // Share result
    async function shareResult() {
      const resultContent = document.getElementById('resultContent');
      if (!resultContent || !resultContent.textContent) {
        alert(currentLang === 'hi' ? '‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§' : 'No result to share.');
        return;
      }
      
      const content = resultContent.textContent;
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Plant Disease Analysis',
            text: content
          });
          console.log('Shared successfully');
        } catch (error) {
          if (error.name !== 'AbortError') {
            console.log('Share failed:', error);
            copyToClipboard(content);
          }
        }
      } else {
        copyToClipboard(content);
      }
    }
    
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          alert(currentLang === 'hi' ? '‚úÖ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!' : '‚úÖ Result copied to clipboard!');
        }).catch(() => {
          alert(currentLang === 'hi' ? '‚ùå ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤' : '‚ùå Failed to copy');
        });
      } else {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          alert(currentLang === 'hi' ? '‚úÖ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!' : '‚úÖ Result copied to clipboard!');
        } catch (err) {
          alert(currentLang === 'hi' ? '‚ùå ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤' : '‚ùå Failed to copy');
        }
        document.body.removeChild(textarea);
      }
    }

    // Request notification permission for reminders
    if ('Notification' in window && Notification.permission === 'default') {
      setTimeout(() => {
        Notification.requestPermission();
      }, 5000);
    }

    // AI Chatbot function
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      const chatMessages = document.getElementById('chatMessages');
      const userMsg = document.createElement('div');
      userMsg.className = 'chat-message user';
      userMsg.textContent = message;
      chatMessages.appendChild(userMsg);
      
      // Clear input
      input.value = '';
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Show typing indicator
      const typingMsg = document.createElement('div');
      typingMsg.className = 'chat-message bot';
      typingMsg.innerHTML = '<em>Typing...</em>';
      typingMsg.id = 'typing';
      chatMessages.appendChild(typingMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      if (!isOnline) {
        // Offline response
        setTimeout(() => {
          document.getElementById('typing').remove();
          const botMsg = document.createElement('div');
          botMsg.className = 'chat-message bot';
          botMsg.textContent = currentLang === 'hi' 
            ? 'üì° ‡§Ü‡§™ ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§π‡•à‡§Ç‡•§ AI ‡§ö‡•à‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§'
            : 'üì° You\'re offline. AI chat requires internet connection. Check the offline database below.';
          chatMessages.appendChild(botMsg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 1000);
        return;
      }
      
      try {
        // Call AI API
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer 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',
            'HTTP-Referer': window.location.href,
            'X-Title': 'Plant Disease Detector PWA'
          },
          body: JSON.stringify({
            model: 'anthropic/claude-3.5-sonnet',
            messages: [{
              role: 'user',
              content: `You are a helpful plant disease expert. Answer this question concisely in ${currentLang === 'hi' ? 'Hindi' : 'English'}: ${message}`
            }]
          })
        });
        
        const data = await response.json();
        const botResponse = data.choices[0].message.content;
        
        // Remove typing indicator
        document.getElementById('typing').remove();
        
        // Add bot response
        const botMsg = document.createElement('div');
        botMsg.className = 'chat-message bot';
        botMsg.textContent = botResponse;
        chatMessages.appendChild(botMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
      } catch (error) {
        document.getElementById('typing').remove();
        const botMsg = document.createElement('div');
        botMsg.className = 'chat-message bot';
        botMsg.textContent = '‚ùå Sorry, I encountered an error. Please try again.';
        chatMessages.appendChild(botMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
  </script>
</body>
</html>